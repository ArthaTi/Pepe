<!DOCTYPE html>
<html>

<head>
  <script
  src="https://code.jquery.com/jquery-3.3.0.min.js"
  integrity="sha256-RTQy8VOmNlT6b2PIRur37p6JEBZUE7o8wPgMvu18MC4="
  crossorigin="anonymous"></script>
  <script src="js/pepe.js"></script>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  
  <style>
	textarea {
	  width: 100%
	}

	pre {
	  white-space: pre-wrap;
	}
  </style>
</head>

<body>

<p>Code <button onclick="gettext()">Generate text</button></p>
<p>Compressed & permalink: <code><a id="link"></a></code></p>
<p style="font-size:0.75em" id="count"></p>
<textarea id="code" rows="15"></textarea>
<p>Input</p>
<textarea id="input"></textarea>
<button id="run">Run</button>

<p>Output</p>
<pre id="output"></pre>
<p>Debug</p>
<pre id="debug"></pre>

<script>
var getlink, gettext, init = false;
getlink = gettext = function(){alert("Wait a bit, then retry, please!")};
$(function() {

	$("#code").keyup(calclen);

	function calclen() {
		if (init) {
			var code = $("#code").val();
			code = code.replace(/#.*/g, "");
			code = code.replace(/[^rReE]/g, "");
			$("#count").text(code.length+" bytes minimum, "+getlink().length+" compressed");
		}
	}
 
	getlink = function() {
		code = $("#code").val();
		code = code.replace(/#.*|[^re]/ig, "");
		code = code.replace(/(r)/gi, " $1");
		code = code.replace(/r/g, "z");
		code = code.replace(/R/g, "Z");
		code = code.replace(/E/g, "1");
		code = code.replace(/e/g, "0");
		code = code.split(" ");
		code = code.filter(function(i) {
			return i
		});
		code = code.map(function(i) {
			return i.charAt(0)+parseInt("1"+i.substr(1), 2).toString(35);
		}).join("");
		//console.log(code);
		$("#link").text(code).attr("href", "#"+code);
		return code;
	}
 
	gettext = function() {
		var val = prompt("Enter text");
		if (!val) val = "";
		var res = "";
		for (let i = 0; i < val.length; i++) { // For each, except first, letter
			var ch = val.charCodeAt(i).toString(2).padStart(8, "e");
			console.log(ch);
			ch = ch.replace(/1/g, "E");
			ch = ch.replace(/0/g, "e");
			res += " re"+ch;
		}
		$("#code").val($("#code").val()+res);
		calclen();
	}

  
    
    try {
    	$("#run").click(function(){
      	$("#debug, #output").text("");
    		$("#output").text(pepe($("#code").val(), $("#input").val(), function(){
        	var d = $("#debug");
          var args = Array.prototype.slice.call(arguments);
        	d.text(d.text()+args.join(" ")+"\n");
          return arguments[0];
        }));
      });
    } catch(a) {
    	console.log("Error caught");
    	$("#debug").text(a.message);
    }
	
	init = true;
	
	
	

	var loadc = location.hash.substr(1);
	if (loadc) {
		var code = loadc.replace(/(z)/gi, " $1");
		code = code.split(" ");
		//console.log(code);
		code = code.filter(function(i) {
			return i
		});
		code = code.map(function(i) {
			console.log(i.charAt(0));
			return i.charAt(0).replace("z", "r").replace("Z", "R")+parseInt(i.substr(1), 35).toString(2).substr(1).replace(/0/g, "e").replace(/1/g, "E");
		}).join(" ");
		$("#code").val(code);
		calclen();
	}
	
});
</script>
</body>

</html>
