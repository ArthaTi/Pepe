<!DOCTYPE html>
<html>

<head>
  <script
  src="http://code.jquery.com/jquery-3.3.0.min.js"
  integrity="sha256-RTQy8VOmNlT6b2PIRur37p6JEBZUE7o8wPgMvu18MC4="
  crossorigin="anonymous"></script>
  <script src="js/pepe.js"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  
  <style>
	textarea {
	  width: 100%
	}

	pre {
	  white-space: pre-wrap;
	  word-wrap: break-word;
	}
  </style>
</head>

<body>

<p>Code <button onclick="gettext()">Generate text</button></p>
<p>Compressed & permalink: <code><a id="link"></a></code></p>
<p style="font-size:0.75em" id="count"></p>
<textarea id="code" rows="15"></textarea>
<p>Input</p>
<textarea id="input"></textarea>
<button id="run">Run</button> <button id="step" disabled>Step</button> <span id="steps"></span>

<p>Output</p>
<pre id="output"></pre>

<p>Execution flags</p>
<div>
	<input type="checkbox" id="boxstep" name="step"> 
	<label for="boxstep">Debug step by step</label>
	
	<div style="margin-left:20px;">
		<input type="checkbox" id="boxclear" name="clear" checked> 
		<label for="boxclear">Clear log each step</label>
	</div>
</div>

<p>Debug</p>
<pre id="debug"></pre>

<script>
var getlink, gettext, init = false;
getlink = gettext = function(){alert("Wait a bit, then retry, please!")};
$(function() {

	$("#code").keyup(calclen);
	
	function upperPepe(x) {
		x = x.toUpperCase();
		x = x.replace(/1/g, "!");
		x = x.replace(/2/g, "@");
		x = x.replace(/3/g, "-");
		x = x.replace(/4/g, "$");
		x = x.replace(/5/g, ".");
		x = x.replace(/6/g, "_");
		x = x.replace(/7/g, "&");
		x = x.replace(/8/g, "*");
		x = x.replace(/9/g, "/");
		x = x.replace(/0/g, "?");
		return x;
	}
	
	function lowerPepe(x) {
		x = x.toLowerCase();
		x = x.replace(/\!/g, "1");
		x = x.replace(/\@/g, "2");
		x = x.replace(/\-/g, "3");
		x = x.replace(/\$/g, "4");
		x = x.replace(/\./g, "5");
		x = x.replace(/\_/g, "6");
		x = x.replace(/\&/g, "7");
		x = x.replace(/\*/g, "8");
		x = x.replace(/\//g, "9");
		x = x.replace(/\?/g, "0");
		return x;
	}

	function calclen() {
		if (init) {
			var code = $("#code").val();
			code = code.replace(/#.*/g, "");
			code = code.replace(/[^rReE]/g, "");
			$("#count").text(code.length+" bytes minimum, "+getlink().length+" compressed");
		}
	}
 
	getlink = function() {
		code = $("#code").val();
		code = code.replace(/#.*|[^re]/ig, "");
		code = code.replace(/(r)/gi, " $1");
		code = code.replace(/E/g, "1");
		code = code.replace(/e/g, "0");
		code = code.split(" ");
		code = code.filter(function(x) {
			return x;
		});
		code = code.map(function(x) {
			var stack = x.charAt(0)
			x = x.substr(1);
			x = "1"+x+(+(stack == "R"));
			x = parseInt(x, 2).toString(36);
			x = upperPepe(x.charAt(0)) + x.substr(1);
			console.log(x);
			return x;
		}).join("");
		//console.log(code);
		
		$("#link").text(code).attr("href", "#"+code);
		return code;
	}
 
	gettext = function() {
		var val = prompt("Enter text");
		if (!val) val = "";
		var res = "";
		for (let i = 0; i < val.length; i++) { // For each, except first, letter
			var ch = val.charCodeAt(i).toString(2).padStart(8, "e");
			console.log(ch);
			ch = ch.replace(/1/g, "E");
			ch = ch.replace(/0/g, "e");
			res += " re"+ch;
		}
		$("#code").val($("#code").val()+res);
		calclen();
	}

  
    
    try {
		var stdlog = function(){
						var d = $("#debug");
						var args = Array.prototype.slice.call(arguments);
						d.text(d.text()+args.join(" ")+"\n");
						return arguments[0];
					}
	
		var exc, res, can=false;
    	$("#run").click(function(){
			$("#debug, #output").text("");
			if ($("[name=step]:checked").length) {
				exc = pepe(
					$("#code").val(),
					$("#input").val(),
					stdlog,
					{"step":true}
				);
				//console.log(exc);
				$("#steps").text(0);
				if (exc) {
					can = true;
					$("#step")
						.prop("disabled", false)
						.click(function() {
							if (!can) return;
						
							if ($("[name=clear]:checked").length) {
								$("#debug").text("");
							}
						
							res = exc();
							console.log(res)
							if (res) {
								$("#output").text(res[1]);	
								$("#steps").text(+$("#steps").text()+1)
							}
							if (!res || res[0]) {
								can = false;
								$("#step").prop("disabled", true);
								stdlog("Execution finished")
							}
						})
				} else {
					stdlog("Nothing to execute.")
				}
			} else {
				$("#output").text(
					pepe($("#code").val(), $("#input").val(), stdlog)
				);
			}
		});
    } catch(a) {
    	console.log("Error caught");
    	$("#debug").text(a.message);
    }
	
	init = true;
	
	
	

	var loadc = location.hash.substr(1);
	if (loadc) {
		var code = loadc;
		
		// If it contains a letter that wasn't used in the old compressor, 
		if (/[\W_A-Y]/.test(code)) {
			// It's the new compressor
			
			code = code.replace(/([\W_A-Z])/g, " $1");
			code = code.split(" ");
			//console.log(code);
			code = code.filter(function(i) {
				return i
			});
			code = code.map(function(i) {
				i = parseInt(lowerPepe(i), 36).toString(2).substr(1);
				var stack = i.slice(-1).replace("0", "r").replace("1", "R");
				return stack + i.slice(0, -1).replace(/0/g, "e").replace(/1/g, "E");
			}).join(" ");
			
		} else {
			// It's the old one
			
			code = code.replace(/(z)/gi, " $1");
			code = code.split(" ");
			//console.log(code);
			code = code.filter(function(i) {
				return i
			});
			code = code.map(function(i) {
				console.log(i.charAt(0));
				return i.charAt(0).replace("z", "r").replace("Z", "R")+parseInt(i.substr(1), 35).toString(2).substr(1).replace(/0/g, "e").replace(/1/g, "E");
			}).join(" ");
			
		}
		
		$("#code").val(code);
		calclen();
	}
	
});
</script>
</body>

</html>
